## 6. 다양한 연관관계 매핑

기억해야 할 것!

테이블은 외래키 하나로 양쪽 조인이 가능하기 때문에 사실 방향이라는 개념이 없다.

객체는 참조용 필드가 있는 쪽으로만 참조가 가능하기 때문에 단방향/양방향으로 나뉜다. (사실은 단방향이 두 개)

<br/>

아래의 모든 이미지 출처는 강의자료

<br/>

#### 다대일 [N:1]

**다대일 단방향**

![image](https://user-images.githubusercontent.com/64277114/179395764-06c02f79-1c33-44bb-a93d-53a76b206c57.png)

다대일 관계에서는 항상 다 쪽에 외래키가 있다. (DB 설계상)

따라서 이 외래키를 기준으로 참조 개체를 넣으면 된다.

<br/>

**다대일 양방향**

![image](https://user-images.githubusercontent.com/64277114/179395908-99e986b1-16a2-4146-85d6-dcbe7e728fd0.png)

단방향에서 양방향으로 바꾸더라도 한 쪽은 어차피 읽기만 가능하기 때문에 영향을 주지 않는다.

외래키가 있는 쪽이 연관관계의 주인이 된다.

**❗ 꿀팁**

'다대일' 처럼 앞에 나오는 '다'가 연관관계의 주인이 된다.

<br/>

#### 일대다 [1:N]

**일대다 단방향**

![image](https://user-images.githubusercontent.com/64277114/179453232-41a42a3d-55e3-44f5-9cf2-8a7c0df3c751.png)

(실무에서 권장하지 않는 모델링)

위와 같은 경우가 되면 Team의 members 값을 바꿨을 때, DB에서 Team이 아닌 Member 테이블의 내용을 바꿔야 한다.

member와 team을 각각 persist한 후 team에 member를 넣어주면, DB에는 update 쿼리가 날라간다.

객체와 테이블의 차이 때문에 반대편 테이블의 외래 키를 관리하는 특이한 구조가 되는 것이다.

따라서 이 방식 보다는 다대일 양방향 매핑을 사용하는 것이 좋다.

<br/>

**일대다 양방향**

![image](https://user-images.githubusercontent.com/64277114/179454902-e6d6aeaa-5632-411f-b3fc-d0258e2c684b.png)

공식적으로 존재하지는 않는 매핑이다.

Member에 @JoinColumn(insertable=false, updatable=false) 옵션을 추가해 읽기 전용 필드로 만들어 양방향 처럼 사용하는 것이다.

이 방법 보다는 다대일 양방향을 사용하자

<br/>

#### 일대일 [1:1]

일대일 관계에서는 주 테이블이나 대상 테이블 중에 어디에 외래 키를 넣을지 선택이 가능하다.

외래 키에 유니크 제약조건이 추가되어야 1:1 관계가 가능

아래는 Member가 주 테이블, Locker가 대상 테이블인 경우의 예시들

**주 테이블에 외래키 단방향**

![image](https://user-images.githubusercontent.com/64277114/179455334-7c95a095-6c8d-467f-922d-c9e6e6c455a9.png)

다대일 단방향 매핑과 유사하며 @OneToOne을 사용해주면 된다. 

<br/>

**주 테이블에 외래키 양방향**

다대일 양방향 매핑처럼 외래 키가 있는 곳이 연관관계의 주인이 되며 반대편은 mappedBy를 적용해주면 된다.

<br/>

**대상 테이블에 외래 키 단방향**

![image](https://user-images.githubusercontent.com/64277114/179456368-a80d2f42-9455-4094-9a98-9a4514884e6e.png)

위 경우는 JPA에서 지원이 되지 않음 !!

<br/>

**대상 테이블에 외래 키 양방향**

![image](https://user-images.githubusercontent.com/64277114/179456551-1652543a-38b6-4a0b-93f2-90d3c722ffec.png)

일대일 주 테이블에 외래키 양방향과 매핑 방법이 같음

<br/>

Member와 Locker중 어느 쪽에 외래키를 두어도 된다.

Locker에 외래키를 두게 되면 나중에 관계가 일대다로 바뀌어도 Unique 제약조건만 빼주면 된다.

Member에 외래키를 두게 되면 위와 같은 상황에서 Locker에 추가되어야 할 컬럼이 생긴다.

개발자 입장에서는 Member가 Locker를 가지고 있는 것이 성능상 유리한 점이 많다.

따라서 향후 비즈니스가 변경될 가능성을 고려해 선택해야 한다.

주 테이블에 외래 키 단방향 방법을 주로 채택

<br/>

#### 다대다 [N:M]

관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없다.

따라서 연결 테이블을 추가해 일대다, 다대일 관계로 풀어내야 한다.

하지만, 객체는 컬렉션을 사용해 객체 2개로 다대다 관계 표현이 가능하다. (@ManyToMany, @JoinTable 사용)

<br/>

편리해 보이지만 실무에서는 사용하지 않는다!

연결 테이블이 연결만 하고 끝나지 않고, 추가 데이터가 더 들어올 수 있기 때문

따라서! 연결 테이블용 엔티티를 추가해 @ManyToMany를 @OneToMany, @ManyToOne으로 나눠주도록 한다.



